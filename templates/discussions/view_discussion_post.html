{% extends "layouts/base.html" %}

{% macro render_replies(replies, post_id, current_user_id, level=0) %}
    <!-- Sort replies by creation date to display chronologically -->
    {% set sorted_replies = replies | sort(attribute='created_at', reverse=false) | list %}
    {% set total_replies = sorted_replies | length %}
    {% set show_count = 2 %}

    <!-- This div wraps all replies at the current level -->
    <div class="space-y-4 {% if level > 0 %}border-l border-gray-200 pl-4{% endif %}">
        {% for reply in sorted_replies %}
            
            <!-- Check if we need to show the toggle button for older replies -->
            {% if total_replies > show_count and loop.index == 1 %}
                <div class="mb-2">
                    <button onclick="toggleCollapsedReplies('collapsed-replies-{{ post_id }}-{{ reply.id }}', this)" 
                            class="text-blue-500 hover:text-blue-700 text-sm font-semibold focus:outline-none">
                        Show {{ total_replies - show_count }} older replies
                    </button>
                </div>
                <!-- Start of the collapsed div for older replies -->
                <div id="collapsed-replies-{{ post_id }}-{{ reply.id }}" class="hidden space-y-4">
            {% endif %}

            <!-- A single reply container with controlled padding -->
            <div class="bg-gray-100 p-4 rounded-lg shadow-sm border border-gray-200">
                <div class="flex items-center space-x-2 text-sm text-gray-500 mb-2">
                    {% if reply.parent_reply %}
                        <span class="text-xs text-gray-400">Replying to {{ reply.parent_reply.author.username }} ({{ reply.parent_reply.author.role }})</span>
                    {% endif %}
                </div>
                <p class="text-sm text-gray-500 mb-2">
                    <span class="font-semibold">{{ reply.author.username }} ({{ reply.author.role }})</span> replied on {{ reply.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                    
                    <!-- Edit and Delete buttons, only visible to the reply author -->
                    {% if reply.author.id == current_user_id %}
                        <span class="text-gray-400">|</span>
                        <button onclick="toggleEditForm('edit-form-{{ reply.id }}')" class="text-indigo-500 hover:text-indigo-700 text-sm font-semibold focus:outline-none">Edit</button>
                        <span class="text-gray-400">|</span>
                        <button onclick="showDeleteModal('{{ url_for('main.delete_reply', reply_id=reply.id, post_id=post_id) }}')" class="text-red-500 hover:text-red-700 text-sm font-semibold focus:outline-none">Delete</button>
                    {% endif %}
                </p>
                <div class="prose max-w-none reply-content-{{ reply.id }}">
                    {{ reply.content | safe }}
                </div>
                <div class="mt-2">
                    <button onclick="toggleReplyForm('reply-form-{{ reply.id }}')" class="text-blue-500 hover:text-blue-700 text-sm font-semibold focus:outline-none">Reply</button>
                </div>

                <!-- Reply form for this specific reply -->
                <div id="reply-form-{{ reply.id }}" class="hidden mt-4 bg-white p-4 rounded-lg border">
                    <form method="POST" action="{{ url_for('main.add_reply', post_id=post_id) }}" class="space-y-3">
                        <input type="hidden" name="parent_reply_id" value="{{ reply.id }}">
                        <textarea name="reply-content" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Write a reply..."></textarea>
                        <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-md focus:outline-none focus:shadow-outline">
                            Submit Reply
                        </button>
                    </form>
                </div>

                <!-- Edit form for this specific reply -->
                <div id="edit-form-{{ reply.id }}" class="hidden mt-4 bg-white p-4 rounded-lg border">
                    <form method="POST" action="{{ url_for('main.edit_reply', reply_id=reply.id, post_id=post_id) }}" class="space-y-3">
                        <textarea name="edit-content" placeholder="reply here..." class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">{{ reply.content | safe }}</textarea>
                        <button type="submit" class="bg-indigo-500 hover:bg-indigo-700 text-white font-bold py-1 px-3 rounded-md focus:outline-none focus:shadow-outline">
                            Save Changes
                        </button>
                        <button type="button" onclick="toggleEditForm('edit-form-{{ reply.id }}')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-1 px-3 rounded-md focus:outline-none focus:shadow-outline">
                            Cancel
                        </button>
                    </form>
                </div>

                <!-- Recursively render child replies with an incremented level -->
                {% if reply.child_replies %}
                    {{ render_replies(reply.child_replies.all(), post_id, current_user_id, level=level + 1) }}
                {% endif %}
            </div>
            
            {% if total_replies > show_count and loop.index == total_replies - show_count %}
                </div> <!-- End of the collapsed div -->
            {% endif %}

        {% endfor %}
    </div>
{% endmacro %}

{% block content %}
<div class="container mx-auto p-6">
    <a href="{{ url_for('main.discussion_board', course_id=post.course.id) }}" class="text-blue-500 hover:underline mb-6 inline-block">&larr; Back to Discussion Board</a>
    
    <!-- Main Discussion Post -->
    <div class="bg-white p-8 rounded-lg shadow-md mb-8">
        <h1 class="text-2xl font-bold mb-2">{{ post.title }}</h1>
        <p class="text-sm text-gray-500 mb-4">
            Posted by <span class="font-semibold">{{ post.author.username }} ({{ post.author.role }})</span> on {{ post.created_at.strftime('%B %d, %Y at %I:%M %p') }}
        </p>
        <div class="prose max-w-none border-t border-gray-200 pt-4 mt-4">
            {{ post.content | safe }}
        </div>
    </div>
    
    <!-- Top-level replies and reply form -->
    <h2 class="text-2xl font-bold mb-4">Replies</h2>
    
    <!-- Form to add a top-level reply -->
    <div class="bg-white p-6 rounded-lg shadow-md mt-8">
        <h2 class="text-2xl font-bold mb-4">Add a Reply</h2>
        <form id="new-reply-form" method="POST" action="{{ url_for('main.add_reply', post_id=post.id) }}">
            <div class="mb-4">
                <textarea id="reply-content" placeholder="reply here..." name="reply-content" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required></textarea>
            </div>
            <div class="flex items-center justify-end">
                <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    Submit Reply
                </button>
            </div>
        </form>
    </div>

    <!-- Replies Section -->
    <div class="mt-8">
        {% if post.replies %}
            <div class="space-y-6">
                {{ render_replies(post.replies.filter_by(parent_reply_id=None).all(), post.id, current_user.id) }}
            </div>
        {% else %}
            <p class="text-gray-500 mt-4">No replies yet. Be the first to start the conversation!</p>
        {% endif %}
    </div>
</div>

<!-- Custom Delete Confirmation Modal -->
<div id="delete-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Confirm Deletion</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500">
                    Are you sure you want to delete this reply? This action cannot be undone.
                </p>
            </div>
            <div class="items-center px-4 py-3">
                <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                    Delete
                </button>
                <button onclick="hideDeleteModal()" class="mt-2 px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.tiny.cloud/1/4um2cjxhribn8kvplgsw1nwx5fvhbi3vydpk5nthap59vjlo/tinymce/8/tinymce.min.js" referrerpolicy="origin" crossorigin="anonymous"></script>
<script>
    let deleteUrl = '';

    function toggleReplyForm(formId) {
        let form = document.getElementById(formId);
        form.classList.toggle('hidden');
    }

    function toggleEditForm(formId) {
        let form = document.getElementById(formId);
        form.classList.toggle('hidden');
    }

    function toggleCollapsedReplies(containerId, button) {
        let container = document.getElementById(containerId);
        if (container.classList.contains('hidden')) {
            container.classList.remove('hidden');
            button.textContent = 'Hide older replies';
        } else {
            container.classList.add('hidden');
            let repliesCount = container.children.length;
            button.textContent = 'Show ' + repliesCount + ' older replies';
        }
    }

    function showDeleteModal(url) {
        deleteUrl = url;
        document.getElementById('delete-modal').classList.remove('hidden');
    }

    function hideDeleteModal() {
        document.getElementById('delete-modal').classList.add('hidden');
    }
    
    document.getElementById('confirm-delete-btn').addEventListener('click', function() {
        if (deleteUrl) {
            window.location.href = deleteUrl;
        }
    });

    tinymce.init({
        selector: '#reply-content',
        plugins: 'advlist autolink lists link image charmap print preview hr anchor pagebreak code codesample emoticons media searchreplace table visualblocks wordcount fullscreen',
        toolbar: 'undo redo | formatselect | bold italic backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | help | link image media code | fullscreen',
        height: 300,
        content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 14px; }',
        
        images_upload_url: "{{ url_for('main.upload_assignment_file') }}",
        media_upload_url: "{{ url_for('main.upload_assignment_file') }}",
        automatic_uploads: true,

        file_picker_callback: function (callback, value, meta) {
            let input = document.createElement('input');
            input.setAttribute('type', 'file');

            if (meta.filetype === 'image') {
                input.setAttribute('accept', 'image/*');
            } else if (meta.filetype === 'media') {
                input.setAttribute('accept', 'video/*');
            }

            input.onchange = function () {
                let file = this.files[0];
                let formData = new FormData();
                formData.append('file', file, file.name);

                fetch("{{ url_for('main.upload_assignment_file') }}", {
                    method: 'POST',
                    body: formData
                }).then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP Error: ' + response.status);
                    }
                    return response.json();
                }).then(data => {
                    if (data.error) {
                        alert('Error uploading file: ' + data.error);
                        return;
                    }
                    callback(data.location, { poster: data.poster });
                }).catch(error => {
                    alert('File upload failed: ' + error.message);
                });
            };

            input.click();
        },
        
        images_upload_handler: function (blobInfo, progress) {
            return new Promise((resolve, reject) => {
                const formData = new FormData();
                formData.append('file', blobInfo.blob(), blobInfo.filename());

                fetch("{{ url_for('main.upload_assignment_file') }}", {
                    method: 'POST',
                    body: formData
                }).then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP Error: ' + response.status);
                    }
                    return response.json();
                }).then(data => {
                    if (data.error) {
                        reject('Error: ' + data.error);
                        return;
                    }
                    resolve(data.location);
                }).catch(error => {
                    reject('Image upload failed: ' + error.message);
                });
            });
        }
    });
</script>
{% endblock %}