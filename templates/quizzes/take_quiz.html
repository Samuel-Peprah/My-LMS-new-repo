{% extends "layouts/base.html" %}

{% block content %}
<div class="container mx-auto p-6">
    <!-- Back Link -->
    <a href="{{ url_for('main.student_dashboard') }}"
        class="text-blue-500 hover:underline mb-6 inline-block">
        ‚Üê Back to My Courses
    </a>
    <!-- Quiz Title -->
    <h1 class="text-3xl font-bold mb-4 text-center">{{ quiz.title }}</h1>

    <!-- Quiz Form -->
    <div class="bg-gray-100 p-6 rounded-lg shadow-md">
        <form id="quiz-submission-form"
                method="POST"
                action="{{ url_for('main.submit_quiz', quiz_id=quiz.id) }}">

            <div class="space-y-8">
                {% for question in quiz_questions %}
                    {% set question_index = loop.index0 %}

                    <!-- Question Block -->
                    <div class="bg-white p-6 rounded-lg shadow-inner border border-gray-200">
                        <h3 class="text-xl font-semibold mb-3">
                            Q{{ loop.index }}. {{ question.question | safe }}
                            <span class="text-gray-500 text-sm">
                                ({{ question.points }} pts)
                            </span>
                        </h3>

                        {% if question.type == 'multiple_choice' %}
                            <!-- Multiple Choice Options -->
                            <div class="space-y-2">
                                {% for option in question.options %}
                                <label class="flex items-center space-x-2 text-gray-700">
                                    <input type="radio"
                                            name="q-{{ question_index }}"
                                            value="{{ option }}"
                                            class="h-4 w-4 text-blue-600 focus:ring-blue-500"
                                            required>
                                    <span>{{ option }}</span>
                                </label>
                                {% endfor %}
                            </div>

                        {% elif question.type == 'open_ended' %}
                            <!-- Open Ended Answer -->
                            <div class="mt-2">
                                <textarea name="q-{{ question_index }}"
                                            id="q-{{ question_index }}"
                                            rows="4"
                                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" 
                                            placeholder="Type your answer here..."
                                            required></textarea>
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>

            <!-- Submit Button -->
            <div class="mt-8 text-center">
                <button type="submit"
                        class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-full focus:outline-none focus:shadow-outline text-lg">
                    Submit Quiz
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Confirmation Modal -->
<div id="confirmation-modal"
        class="fixed inset-0 z-50 flex items-center justify-center hidden bg-gray-600 bg-opacity-50">
    <div class="bg-white p-6 rounded-lg shadow-xl w-1/3">
        <p class="text-xl font-bold mb-4">Confirm Submission</p>
        <p class="text-gray-700 mb-6">
            Are you sure you want to submit this quiz? You cannot edit your answers after submitting.
        </p>
        <div class="flex justify-end space-x-4">
            <button id="cancel-submit"
                    type="button"
                    class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">
                Cancel
            </button>
            <button id="confirm-submit"
                    type="button"
                    class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                Submit
            </button>
        </div>
    </div>
</div>

<script src="https://cdn.tiny.cloud/1/4um2cjxhribn8kvplgsw1nwx5fvhbi3vydpk5nthap59vjlo/tinymce/8/tinymce.min.js" referrerpolicy="origin" crossorigin="anonymous"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('quiz-submission-form');
        const submitButton = form.querySelector('button[type="submit"]');
        const modal = document.getElementById('confirmation-modal');
        const confirmBtn = document.getElementById('confirm-submit');
        const cancelBtn = document.getElementById('cancel-submit');

        submitButton.addEventListener('click', function(event) {
            // Prevent the default form submission immediately
            event.preventDefault();
            // Show the custom modal
            modal.classList.remove('hidden');
        });

        confirmBtn.addEventListener('click', function() {
            // Re-submit the form programmatically after confirmation
            modal.classList.add('hidden');
            form.submit();
        });

        cancelBtn.addEventListener('click', function() {
            // Hide the modal if the user cancels
            modal.classList.add('hidden');
        });
        
        // This is the correct way to initialize TinyMCE on the open-ended textareas
        tinymce.init({
            selector: 'textarea[name^="q-"]', // Target all textareas whose name starts with "q-"
            plugins: 'advlist autolink lists link image charmap print preview hr anchor pagebreak code codesample emoticons media searchreplace table visualblocks wordcount fullscreen',
            toolbar_mode: 'floating',
            toolbar: 'undo redo | formatselect | bold italic backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | help | link image media code | fullscreen',
            height: 300,
            content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 14px; }',
            
            // This is the key change: these URLs point to our new Flask route
            images_upload_url: "{{ url_for('main.upload_assignment_file') }}",
            media_upload_url: "{{ url_for('main.upload_assignment_file') }}",
            automatic_uploads: true,

            file_picker_callback: function (callback, value, meta) {
                let input = document.createElement('input');
                input.setAttribute('type', 'file');

                if (meta.filetype === 'image') {
                    input.setAttribute('accept', 'image/*');
                } else if (meta.filetype === 'media') {
                    input.setAttribute('accept', 'video/*');
                }

                input.onchange = function () {
                    let file = this.files[0];
                    let formData = new FormData();
                    formData.append('file', file, file.name);

                    fetch("{{ url_for('main.upload_assignment_file') }}", {
                        method: 'POST',
                        body: formData
                    }).then(response => {
                        if (!response.ok) {
                            throw new Error('HTTP Error: ' + response.status);
                        }
                        return response.json();
                    }).then(data => {
                        if (data.error) {
                            alert('Error uploading file: ' + data.error);
                            return;
                        }
                        callback(data.location, { poster: data.poster });
                    }).catch(error => {
                        alert('File upload failed: ' + error.message);
                    });
                };

                input.click();
            },
            
            images_upload_handler: function (blobInfo, progress) {
                return new Promise((resolve, reject) => {
                    const formData = new FormData();
                    formData.append('file', blobInfo.blob(), blobInfo.filename());

                    fetch("{{ url_for('main.upload_assignment_file') }}", {
                        method: 'POST',
                        body: formData
                    }).then(response => {
                        if (!response.ok) {
                            throw new Error('HTTP Error: ' + response.status);
                        }
                        return response.json();
                    }).then(data => {
                        if (data.error) {
                            reject('Error: ' + data.error);
                            return;
                        }
                        resolve(data.location);
                    }).catch(error => {
                        reject('Image upload failed: ' + error.message);
                    });
                });
            }
        });
    });
</script>

{% endblock %}