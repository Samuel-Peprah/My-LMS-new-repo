{% extends "layouts/base.html" %}

{% block content %}
<div class="container mx-auto p-4">
    <a href="{{ url_for('main.manage_quizzes', course_id=quiz.course.id) }}" class="text-blue-500 hover:text-2xl mb-6 inline-block flex items-center">
        <i class="iconify text-[#1a47ef] text-3xl" data-icon="ic:twotone-logout"></i>
            Back to Quizzes
    </a>
    <h1 class="text-2xl font-bold mb-4 font-sans text-center">{{ quiz.title }}</h1>

    {% if submissions %}
    <div class="bg-white p-4 rounded-lg shadow-md">
        <h2 class="text-xl font-semibold mb-4">Student Submissions</h2>
        <div class="overflow-x-auto p-4">
            <table class="min-w-full bg-white rounded-lg shadow-sm">
                <thead class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                    <tr>
                        <th class="py-3 px-6 text-left">Student</th>
                        <th class="py-3 px-6 text-left">Submitted On</th>
                        <th class="py-3 px-6 text-left">Score</th>
                        <th class="py-3 px-6 text-left">Percentage</th>
                        <th class="py-3 px-6 text-center">Actions</th>
                    </tr>
                </thead>
                <tbody class="text-gray-700 text-sm">
                    {% for submission in submissions %}
                    <tr class="border-b hover:bg-gray-50">
                        <td class="py-3 px-6">{{ submission.student.username }}</td>
                        <td class="py-3 px-6">
                            {{ submission.submission_dates.strftime('%Y-%m-%d %H:%M') if submission.submission_dates else 'N/A' }}
                        </td>
                        <td class="py-3 px-6 font-semibold
                            {% if submission.score <= total_possible_score / 3 %}
                                text-red-600
                            {% elif submission.score <= (total_possible_score * 2 / 3) %}
                                text-yellow-600
                            {% else %}
                                text-green-600
                            {% endif %}
                        ">
                            {{ submission.score }} / {{ total_possible_score }}
                        </td>
                        <td class="py-3 px-6 font-semibold
                            {% if submission.score <= total_possible_score / 3 %}
                                text-red-600
                            {% elif submission.score <= (total_possible_score * 2 / 3) %}
                                text-yellow-600
                            {% else %}
                                text-green-600
                            {% endif %}
                        ">
                            {{ (submission.score / total_possible_score * 100) | round(2) }}%
                        </td>
                        <td class="py-3 px-6 text-center space-x-2">
                            <a href="{{ url_for('main.teacher_quiz_results', submission_id=submission.id) }}"
                                class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-1 px-3 rounded-lg transition duration-300">
                                View
                            </a>
                            <hr class="my-2">
                            <a href="{{ url_for('main.teacher_grade_submission', submission_id=submission.id) }}"
                                class="bg-green-500 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-lg transition duration-300">
                                Grade
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div class="bg-white p-4 rounded-lg shadow-md">
        <p class="text-gray-700 font-sans">No students have submitted this quiz yet.</p>
    </div>
    {% endif %}
</div>

<script src="https://cdn.tiny.cloud/1/4um2cjxhribn8kvplgsw1nwx5fvhbi3vydpk5nthap59vjlo/tinymce/8/tinymce.min.js" referrerpolicy="origin" crossorigin="anonymous"></script>
<script>
    tinymce.init({
        // Target the description textarea
        selector: '#description',
        plugins: 'advlist autolink lists link image charmap print preview hr anchor pagebreak code codesample emoticons media searchreplace table visualblocks wordcount',
        toolbar_mode: 'floating',
        toolbar: 'undo redo | formatselect | bold italic backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | help | link image media code',
        height: 300,
        content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 14px; }',
        
        // This is the key change: these URLs point to our new Flask route
        images_upload_url: "{{ url_for('main.upload_assignment_file') }}",
        media_upload_url: "{{ url_for('main.upload_assignment_file') }}",
        automatic_uploads: true,

        file_picker_callback: function (callback, value, meta) {
            let input = document.createElement('input');
            input.setAttribute('type', 'file');

            if (meta.filetype === 'image') {
                input.setAttribute('accept', 'image/*');
            } else if (meta.filetype === 'media') {
                input.setAttribute('accept', 'video/*');
            }

            input.onchange = function () {
                let file = this.files[0];
                let formData = new FormData();
                formData.append('file', file, file.name);

                fetch("{{ url_for('main.upload_assignment_file') }}", {
                    method: 'POST',
                    body: formData
                }).then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP Error: ' + response.status);
                    }
                    return response.json();
                }).then(data => {
                    if (data.error) {
                        // Use a custom modal or alert to show the error
                        alert('Error uploading file: ' + data.error);
                        return;
                    }
                    // Pass the video location and the thumbnail (poster) back to TinyMCE
                    callback(data.location, { poster: data.poster });
                }).catch(error => {
                    alert('File upload failed: ' + error.message);
                });
            };

            input.click();
        },
        
        images_upload_handler: function (blobInfo, progress) {
            return new Promise((resolve, reject) => {
                const formData = new FormData();
                formData.append('file', blobInfo.blob(), blobInfo.filename());

                fetch("{{ url_for('main.upload_assignment_file') }}", {
                    method: 'POST',
                    body: formData
                }).then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP Error: ' + response.status);
                    }
                    return response.json();
                }).then(data => {
                    if (data.error) {
                        reject('Error: ' + data.error);
                        return;
                    }
                    resolve(data.location);
                }).catch(error => {
                    reject('Image upload failed: ' + error.message);
                });
            });
        }
    });
</script>

{% endblock %}
